<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虚拟实验 - 计算机组成原理</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fafafa;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 240px;
            background: linear-gradient(180deg, #fff, #f5f9fc);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        /* 主内容区域样式 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* 顶部导航栏 */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* 用户头像样式 */
        .user-profile {
            display: flex;
            align-items: center;
            cursor: pointer;
            gap: 8px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #20beff;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #20beff, #0056b3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            margin-right: 8px;
        }

        .avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 10px rgba(32, 190, 255, 0.3);
        }

        .search-bar input {
            padding: 8px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            width: 300px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #20beff;
            box-shadow: 0 2px 10px rgba(32, 190, 255, 0.2);
        }

        /* 实验区域布局 */
        .experiment-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 60px);
        }

        /* 左侧组件库 */
        .component-library {
            width: 220px;
            background-color: #f5f9fc;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            padding: 15px;
        }

        .component-category {
            margin-bottom: 15px;
        }

        .category-title {
            font-size: 14px;
            font-weight: 500;
            color: #555;
            padding: 8px 10px;
            background-color: #e9f5ff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .category-title:after {
            content: '▼';
            font-size: 10px;
            transition: transform 0.3s ease;
        }

        .category-title.collapsed:after {
            transform: rotate(-90deg);
        }

        .component-list {
            padding-left: 10px;
        }

        .component-item {
            padding: 6px 10px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            transition: all 0.2s ease;
        }

        .component-item:hover {
            background-color: rgba(32, 190, 255, 0.1);
            color: #20beff;
        }

        /* 中央设计画布 */
        .design-canvas {
            flex: 1;
            background-color: #fff;
            position: relative;
            overflow: hidden;
        }

        /* 可拖动组件样式 */
        .draggable-component {
            position: absolute;
            background-color: white;
            border: 2px solid #20beff;
            border-radius: 4px;
            padding: 10px;
            width: 100px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            user-select: none;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s ease;
        }

        /* IO端口样式 */
        .port {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #555;
            border: 2px solid #333;
            border-radius: 50%;
            z-index: 11;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .port:hover {
            background-color: #20beff;
            transform: scale(1.2);
        }

        .port.input-port {
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .port.output-port {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .port.connected {
            background-color: #28a745;
        }

        /* 连线样式 */
        .wire {
            position: absolute;
            height: 3px;
            background-color: #20beff;
            transform-origin: left center;
            z-index: 5;
            pointer-events: none;
            box-shadow: 0 0 3px rgba(32, 190, 255, 0.5);
        }

        .draggable-component:hover {
            box-shadow: 0 4px 8px rgba(32, 190, 255, 0.3);
        }

        .draggable-component.gate {
            background-color: #e9f5ff;
        }

        .draggable-component.wiring {
            background-color: #f0f8ff;
        }

        .draggable-component.memory {
            background-color: #fff8e1;
        }

        .draggable-component.io {
            background-color: #f1f8e9;
        }

        .component-label {
            font-size: 12px;
            font-weight: 500;
            color: #555;
            text-align: center;
        }

        .grid-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: radial-gradient(circle, #ddd 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: 0;
        }

        /* 右侧评分系统 */
        .scoring-system {
            width: 280px;
            background-color: #f8f9fa;
            border-left: 1px solid #e0e0e0;
            padding: 15px;
            overflow-y: auto;
        }

        .score-panel {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 15px;
            margin-bottom: 20px;
        }

        .score-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .score-value {
            font-size: 28px;
            font-weight: bold;
            color: #20beff;
            text-align: center;
            margin: 15px 0;
        }

        .progress-bar {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #20beff, #0056b3);
            width: 65%;
            border-radius: 4px;
        }

        .feedback-list {
            margin-top: 15px;
        }

        .feedback-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .feedback-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #f8d7da;
            color: #dc3545;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .feedback-icon.success {
            background-color: #d4edda;
            color: #28a745;
        }

        .feedback-text {
            font-size: 13px;
            color: #666;
            flex: 1;
        }

        /* 底部工具栏 */
        .bottom-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .tool-buttons {
            display: flex;
            gap: 10px;
        }

        .tool-btn {
            padding: 6px 12px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            color: #555;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tool-btn:hover {
            border-color: #20beff;
            color: #20beff;
        }

        .simulate-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #20beff, #0056b3);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .simulate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(32, 190, 255, 0.3);
        }

        .username {
            margin-left: 10px;
            font-weight: 500;
            color: #0056b3;
        }
    </style>
</head>

<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo">kaggle</div>
            <button class="create-btn">+ 创建</button>
            <nav class="menu">
                <ul>
                    <li><a href="kaggle.html">首页</a></li>
                    <li><a href="online_learning.html">在线学习</a></li>
                    <li class="active"><a href="virtual_experiment.html">虚拟实验</a></li>
                    <li><a href="exam_simulation.html">应试模拟</a></li>
                    <li><a href="discussion.html">社区讨论</a></li>
                </ul>
            </nav>
            <div class="work-section">
                <p>学习进度</p>
                <ul>
                    <li><a href="#">计算机组成原理 - 25%</a></li>
                    <li><a href="#">最近实验 - CPU设计</a></li>
                </ul>
            </div>
            <div class="events-section">
                <p>热门讨论</p>
                <ul>
                    <li><a href="#">如何理解流水线设计？</a></li>
                    <li><a href="#">MIPS指令集学习心得</a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-nav">
                <div class="search-bar">
                    <input type="text" placeholder="搜索组件或实验项目">
                </div>
                <div class="nav-actions">
                    <button class="app-download-btn">App下载</button>
                    <div class="user-profile">
                        <div class="avatar">A</div>
                        <span class="username">ashchao</span>
                    </div>
                </div>
            </header>

            <div class="bottom-toolbar">
                <div class="tool-buttons">
                    <button class="tool-btn">撤销</button>
                    <button class="tool-btn">重做</button>
                    <button class="tool-btn">删除</button>
                    <button class="tool-btn">清空画布</button>
                </div>
                <button class="simulate-btn">模拟运行</button>
            </div>

            <div class="experiment-container">
                <!-- 左侧组件库 -->
                <div class="component-library">
                    <div class="component-category">
                        <div class="category-title">Wiring（布线）</div>
                        <div class="component-list">
                            <div class="component-item">电线</div>
                            <div class="component-item">分线器</div>
                            <div class="component-item">电源</div>
                            <div class="component-item">接地</div>
                        </div>
                    </div>

                    <div class="component-category">
                        <div class="category-title">Gates（逻辑门）</div>
                        <div class="component-list">
                            <div class="component-item">与门</div>
                            <div class="component-item">或门</div>
                            <div class="component-item">非门</div>
                            <div class="component-item">异或门</div>
                            <div class="component-item">与非门</div>
                            <div class="component-item">或非门</div>
                        </div>
                    </div>

                    <div class="component-category">
                        <div class="category-title">Plexers（多路选择器）</div>
                        <div class="component-list">
                            <div class="component-item">多路复用器</div>
                            <div class="component-item">解复用器</div>
                            <div class="component-item">优先编码器</div>
                        </div>
                    </div>

                    <div class="component-category">
                        <div class="category-title">Arithmetic（算术组件）</div>
                        <div class="component-list">
                            <div class="component-item">加法器</div>
                            <div class="component-item">减法器</div>
                            <div class="component-item">乘法器</div>
                            <div class="component-item">比较器</div>
                        </div>
                    </div>

                    <div class="component-category">
                        <div class="category-title">Memory（存储组件）</div>
                        <div class="component-list">
                            <div class="component-item">D触发器</div>
                            <div class="component-item">T触发器</div>
                            <div class="component-item">JK触发器</div>
                            <div class="component-item">寄存器</div>
                            <div class="component-item">RAM</div>
                            <div class="component-item">ROM</div>
                        </div>
                    </div>

                    <div class="component-category">
                        <div class="category-title">Input/Output（输入输出）</div>
                        <div class="component-list">
                            <div class="component-item">按钮</div>
                            <div class="component-item">开关</div>
                            <div class="component-item">LED灯</div>
                            <div class="component-item">七段数码管</div>
                        </div>
                    </div>
                </div>

                <!-- 中央设计画布 -->
                <div class="design-canvas">
                    <div class="grid-background"></div>
                    <!-- 这里将放置用户拖放的组件 -->
                </div>

                <!-- 右侧评分系统 -->
                <div class="scoring-system">
                    <div class="score-panel">
                        <div class="score-title">电路可行性评分</div>
                        <div class="score-value">65/100</div>
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <div class="feedback-list">
                            <div class="feedback-item">
                                <div class="feedback-icon success">✓</div>
                                <div class="feedback-text">组件连接正确</div>
                            </div>
                            <div class="feedback-item">
                                <div class="feedback-icon success">✓</div>
                                <div class="feedback-text">输入端口配置正确</div>
                            </div>
                            <div class="feedback-item">
                                <div class="feedback-icon">✗</div>
                                <div class="feedback-text">电源连接不完整，请检查</div>
                            </div>
                            <div class="feedback-item">
                                <div class="feedback-icon">✗</div>
                                <div class="feedback-text">输出端口未连接</div>
                            </div>
                        </div>
                    </div>

                    <div class="score-panel">
                        <div class="score-title">实验要求</div>
                        <div class="feedback-list">
                            <div class="feedback-item">
                                <div class="feedback-icon success">✓</div>
                                <div class="feedback-text">使用基本逻辑门</div>
                            </div>
                            <div class="feedback-item">
                                <div class="feedback-icon">✗</div>
                                <div class="feedback-text">实现2位全加器功能</div>
                            </div>
                            <div class="feedback-item">
                                <div class="feedback-icon">✗</div>
                                <div class="feedback-text">添加输入开关和输出显示</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 简单交互效果
        document.addEventListener('DOMContentLoaded', function () {
            // 组件分类折叠/展开
            const categoryTitles = document.querySelectorAll('.category-title');
            categoryTitles.forEach(title => {
                title.addEventListener('click', function () {
                    this.classList.toggle('collapsed');
                    const list = this.nextElementSibling;
                    list.style.display = this.classList.contains('collapsed') ? 'none' : 'block';
                });
            });

            // 模拟按钮点击效果
            const simulateBtn = document.querySelector('.simulate-btn');
            simulateBtn.addEventListener('click', function () {
                evaluateCircuit();
                alert('开始模拟运行电路...');
            });

            // 获取设计画布元素
            const designCanvas = document.querySelector('.design-canvas');
            let componentCounter = 0;
            let selectedComponent = null;
            let offsetX, offsetY;
            let placedComponents = [];

            // 为组件项添加点击事件
            const componentItems = document.querySelectorAll('.component-item');
            componentItems.forEach(item => {
                item.addEventListener('click', function () {
                    const componentName = this.textContent;
                    const parentCategory = this.closest('.component-category');
                    const categoryTitle = parentCategory.querySelector('.category-title').textContent;

                    // 创建新组件
                    createComponent(componentName, categoryTitle);
                });
            });

            // 全局变量用于线路连接
            let activePort = null;
            let wires = [];

            // 创建组件函数
            function createComponent(name, category) {
                componentCounter++;
                const component = document.createElement('div');
                component.className = 'draggable-component';
                component.id = `component-${componentCounter}`;

                // 根据类别添加不同的样式类
                if (category.includes('Gates')) {
                    component.classList.add('gate');
                } else if (category.includes('Wiring')) {
                    component.classList.add('wiring');
                } else if (category.includes('Memory')) {
                    component.classList.add('memory');
                } else if (category.includes('Input/Output')) {
                    component.classList.add('io');
                }

                // 设置组件内容
                component.innerHTML = `<div class="component-label">${name}</div>`;

                // 添加输入和输出端口
                const inputPort = document.createElement('div');
                inputPort.className = 'port input-port';
                inputPort.dataset.componentId = component.id;
                inputPort.dataset.portType = 'input';

                const outputPort = document.createElement('div');
                outputPort.className = 'port output-port';
                outputPort.dataset.componentId = component.id;
                outputPort.dataset.portType = 'output';

                component.appendChild(inputPort);
                component.appendChild(outputPort);

                // 为端口添加点击事件
                inputPort.addEventListener('click', handlePortClick);
                outputPort.addEventListener('click', handlePortClick);

                // 设置初始位置（画布中心附近的随机位置）
                const canvasRect = designCanvas.getBoundingClientRect();
                const randomX = Math.random() * (canvasRect.width - 100) + 50;
                const randomY = Math.random() * (canvasRect.height - 100) + 50;

                component.style.left = `${randomX}px`;
                component.style.top = `${randomY}px`;

                // 添加到画布
                designCanvas.appendChild(component);

                // 记录组件
                placedComponents.push({
                    id: component.id,
                    name: name,
                    category: category,
                    x: randomX,
                    y: randomY,
                    inputConnected: false,
                    outputConnected: false
                });

                // 添加拖动事件
                component.addEventListener('mousedown', startDrag);

                // 更新评分
                updateFeedback();
            }

            // 处理端口点击事件
            function handlePortClick(e) {
                e.stopPropagation(); // 阻止事件冒泡，避免触发组件拖动

                const port = e.target;
                const componentId = port.dataset.componentId;
                const portType = port.dataset.portType;

                // 如果没有活动端口，则设置当前端口为活动端口
                if (!activePort) {
                    activePort = port;
                    port.classList.add('connected');
                    return;
                }

                // 如果点击的是同一个端口，取消选择
                if (activePort === port) {
                    activePort.classList.remove('connected');
                    activePort = null;
                    return;
                }

                // 如果点击的是同一个组件的另一个端口，不允许连接
                if (activePort.dataset.componentId === componentId) {
                    return;
                }

                // 如果两个端口类型相同，不允许连接（输入到输入或输出到输出）
                if (activePort.dataset.portType === portType) {
                    return;
                }

                // 创建连线
                createWire(activePort, port);

                // 重置活动端口
                activePort.classList.remove('connected');
                port.classList.add('connected');
                activePort = null;
            }

            // 创建连线函数
            function createWire(startPort, endPort) {
                // 确保起点是输出端口，终点是输入端口
                if (startPort.dataset.portType === 'input') {
                    [startPort, endPort] = [endPort, startPort];
                }

                // 获取端口的位置
                const startRect = startPort.getBoundingClientRect();
                const endRect = endPort.getBoundingClientRect();
                const canvasRect = designCanvas.getBoundingClientRect();

                // 计算端口在画布中的相对位置
                const startX = startRect.left + startRect.width / 2 - canvasRect.left;
                const startY = startRect.top + startRect.height / 2 - canvasRect.top;
                const endX = endRect.left + endRect.width / 2 - canvasRect.left;
                const endY = endRect.top + endRect.height / 2 - canvasRect.top;

                // 创建连线元素
                const wire = document.createElement('div');
                wire.className = 'wire';
                wire.dataset.startComponentId = startPort.dataset.componentId;
                wire.dataset.endComponentId = endPort.dataset.componentId;

                // 计算连线长度和角度
                const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;

                // 设置连线样式
                wire.style.width = `${length}px`;
                wire.style.left = `${startX}px`;
                wire.style.top = `${startY}px`;
                wire.style.transform = `rotate(${angle}deg)`;

                // 添加到画布
                designCanvas.appendChild(wire);

                // 记录连线
                wires.push({
                    element: wire,
                    startComponentId: startPort.dataset.componentId,
                    endComponentId: endPort.dataset.componentId,
                    startX: startX,
                    startY: startY,
                    endX: endX,
                    endY: endY
                });

                // 更新组件连接状态
                updateComponentConnectionStatus(startPort.dataset.componentId, endPort.dataset.componentId);

                // 更新评分
                updateFeedback();
            }

            // 更新组件连接状态
            function updateComponentConnectionStatus(startId, endId) {
                const startIndex = placedComponents.findIndex(comp => comp.id === startId);
                const endIndex = placedComponents.findIndex(comp => comp.id === endId);

                if (startIndex !== -1) {
                    placedComponents[startIndex].outputConnected = true;
                }

                if (endIndex !== -1) {
                    placedComponents[endIndex].inputConnected = true;
                }
            }

            // 开始拖动
            function startDrag(e) {
                e.preventDefault();
                selectedComponent = this;

                // 计算鼠标在组件内的偏移量
                const rect = selectedComponent.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;

                // 将选中的组件置于顶层
                selectedComponent.style.zIndex = '100';

                // 添加移动和释放事件
                document.addEventListener('mousemove', dragMove);
                document.addEventListener('mouseup', stopDrag);
            }

            // 拖动移动
            function dragMove(e) {
                if (!selectedComponent) return;

                const canvasRect = designCanvas.getBoundingClientRect();
                let newX = e.clientX - canvasRect.left - offsetX;
                let newY = e.clientY - canvasRect.top - offsetY;

                // 限制在画布内
                newX = Math.max(0, Math.min(newX, canvasRect.width - selectedComponent.offsetWidth));
                newY = Math.max(0, Math.min(newY, canvasRect.height - selectedComponent.offsetHeight));

                selectedComponent.style.left = `${newX}px`;
                selectedComponent.style.top = `${newY}px`;

                // 更新组件位置记录
                const componentId = selectedComponent.id;
                const componentIndex = placedComponents.findIndex(comp => comp.id === componentId);
                if (componentIndex !== -1) {
                    placedComponents[componentIndex].x = newX;
                    placedComponents[componentIndex].y = newY;
                }

                // 更新与该组件相关的所有连线
                updateWiresForComponent(componentId);
            }

            // 更新组件相关的连线
            function updateWiresForComponent(componentId) {
                // 找到与该组件相关的所有连线
                const relatedWires = wires.filter(wire =>
                    wire.startComponentId === componentId || wire.endComponentId === componentId
                );

                relatedWires.forEach(wire => {
                    // 获取起点和终点组件的端口元素
                    const startComponent = document.getElementById(wire.startComponentId);
                    const endComponent = document.getElementById(wire.endComponentId);

                    if (!startComponent || !endComponent) return;

                    const startPort = startComponent.querySelector('.output-port');
                    const endPort = endComponent.querySelector('.input-port');

                    if (!startPort || !endPort) return;

                    // 获取端口的新位置
                    const startRect = startPort.getBoundingClientRect();
                    const endRect = endPort.getBoundingClientRect();
                    const canvasRect = designCanvas.getBoundingClientRect();

                    // 计算端口在画布中的相对位置
                    const startX = startRect.left + startRect.width / 2 - canvasRect.left;
                    const startY = startRect.top + startRect.height / 2 - canvasRect.top;
                    const endX = endRect.left + endRect.width / 2 - canvasRect.left;
                    const endY = endRect.top + endRect.height / 2 - canvasRect.top;

                    // 计算连线长度和角度
                    const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;

                    // 更新连线样式
                    wire.element.style.width = `${length}px`;
                    wire.element.style.left = `${startX}px`;
                    wire.element.style.top = `${startY}px`;
                    wire.element.style.transform = `rotate(${angle}deg)`;

                    // 更新连线记录
                    wire.startX = startX;
                    wire.startY = startY;
                    wire.endX = endX;
                    wire.endY = endY;
                    wire.endX = endX;
                    wire.endY = endY;
                });
            }

            // 停止拖动
            function stopDrag() {
                if (selectedComponent) {
                    selectedComponent.style.zIndex = '10';
                    selectedComponent = null;
                }

                document.removeEventListener('mousemove', dragMove);
                document.removeEventListener('mouseup', stopDrag);

                // 更新评分
                updateFeedback();
            }

            // 工具栏按钮功能
            const clearCanvasBtn = document.querySelector('.tool-btn:nth-child(4)');
            clearCanvasBtn.addEventListener('click', function () {
                // 清空画布上的所有组件
                const components = document.querySelectorAll('.draggable-component');
                components.forEach(comp => comp.remove());

                // 清空画布上的所有连线
                const wireElements = document.querySelectorAll('.wire');
                wireElements.forEach(wire => wire.remove());

                // 重置所有状态
                placedComponents = [];
                wires = [];
                componentCounter = 0;
                activePort = null;

                updateFeedback();
            });

            const deleteBtn = document.querySelector('.tool-btn:nth-child(3)');
            deleteBtn.addEventListener('click', function () {
                if (selectedComponent) {
                    const componentId = selectedComponent.id;

                    // 删除与该组件相关的所有连线
                    removeWiresForComponent(componentId);

                    // 删除组件
                    const componentIndex = placedComponents.findIndex(comp => comp.id === componentId);
                    if (componentIndex !== -1) {
                        placedComponents.splice(componentIndex, 1);
                    }
                    selectedComponent.remove();
                    selectedComponent = null;

                    // 如果有活动端口，重置它
                    if (activePort && activePort.dataset.componentId === componentId) {
                        activePort = null;
                    }

                    updateFeedback();
                } else {
                    alert('请先选择要删除的组件');
                }
            });

            // 删除与组件相关的所有连线
            function removeWiresForComponent(componentId) {
                // 找到与该组件相关的所有连线
                const relatedWires = wires.filter(wire =>
                    wire.startComponentId === componentId || wire.endComponentId === componentId
                );

                // 从DOM中移除连线元素
                relatedWires.forEach(wire => {
                    wire.element.remove();

                    // 更新连接到这些线的组件的连接状态
                    const otherComponentId = wire.startComponentId === componentId ?
                        wire.endComponentId : wire.startComponentId;

                    const otherComponentIndex = placedComponents.findIndex(comp => comp.id === otherComponentId);
                    if (otherComponentIndex !== -1) {
                        if (wire.startComponentId === componentId) {
                            placedComponents[otherComponentIndex].inputConnected = false;
                        } else {
                            placedComponents[otherComponentIndex].outputConnected = false;
                        }
                    }
                });

                // 从wires数组中移除这些连线
                wires = wires.filter(wire =>
                    wire.startComponentId !== componentId && wire.endComponentId !== componentId
                );
            }

            // 评估电路并更新反馈
            function evaluateCircuit() {
                // 检查是否有足够的组件
                const hasLogicGates = placedComponents.some(comp => comp.category.includes('Gates'));
                const hasInputOutput = placedComponents.some(comp => comp.category.includes('Input/Output'));
                const hasWiring = placedComponents.some(comp => comp.category.includes('Wiring'));

                // 检查连线状态
                const hasConnections = wires.length > 0;
                const connectedComponents = new Set();
                wires.forEach(wire => {
                    connectedComponents.add(wire.startComponentId);
                    connectedComponents.add(wire.endComponentId);
                });
                const allComponentsConnected = placedComponents.length > 0 &&
                    placedComponents.every(comp => connectedComponents.has(comp.id) ||
                        comp.category.includes('Wiring'));
                const hasCompleteCircuit = hasConnections && allComponentsConnected;

                // 更新电路可行性评分
                const feedbackItems = document.querySelectorAll('.score-panel:first-child .feedback-item');

                // 组件连接正确
                if (hasLogicGates && hasWiring && hasConnections) {
                    feedbackItems[0].querySelector('.feedback-icon').className = 'feedback-icon success';
                    feedbackItems[0].querySelector('.feedback-icon').innerHTML = '✓';
                } else {
                    feedbackItems[0].querySelector('.feedback-icon').className = 'feedback-icon';
                    feedbackItems[0].querySelector('.feedback-icon').innerHTML = '✗';
                }

                // 输入端口配置正确
                if (hasInputOutput) {
                    feedbackItems[1].querySelector('.feedback-icon').className = 'feedback-icon success';
                    feedbackItems[1].querySelector('.feedback-icon').innerHTML = '✓';
                } else {
                    feedbackItems[1].querySelector('.feedback-icon').className = 'feedback-icon';
                    feedbackItems[1].querySelector('.feedback-icon').innerHTML = '✗';
                }

                // 电源连接
                const hasPower = placedComponents.some(comp => comp.name === '电源');
                const powerConnected = hasPower && wires.some(wire => {
                    const startComp = placedComponents.find(comp => comp.id === wire.startComponentId);
                    return startComp && startComp.name === '电源';
                });

                if (hasPower && powerConnected) {
                    feedbackItems[2].querySelector('.feedback-icon').className = 'feedback-icon success';
                    feedbackItems[2].querySelector('.feedback-icon').innerHTML = '✓';
                } else {
                    feedbackItems[2].querySelector('.feedback-icon').className = 'feedback-icon';
                    feedbackItems[2].querySelector('.feedback-icon').innerHTML = '✗';
                }

                // 输出端口
                const hasOutput = placedComponents.some(comp =>
                    comp.name === 'LED灯' || comp.name === '七段数码管');
                const outputConnected = hasOutput && wires.some(wire => {
                    const endComp = placedComponents.find(comp => comp.id === wire.endComponentId);
                    return endComp && (endComp.name === 'LED灯' || endComp.name === '七段数码管');
                });

                if (hasOutput && outputConnected) {
                    feedbackItems[3].querySelector('.feedback-icon').className = 'feedback-icon success';
                    feedbackItems[3].querySelector('.feedback-icon').innerHTML = '✓';
                } else {
                    feedbackItems[3].querySelector('.feedback-icon').className = 'feedback-icon';
                    feedbackItems[3].querySelector('.feedback-icon').innerHTML = '✗';
                }

                // 更新实验要求评分
                const requirementItems = document.querySelectorAll('.score-panel:nth-child(2) .feedback-item');

                // 使用基本逻辑门
                if (hasLogicGates) {
                    requirementItems[0].querySelector('.feedback-icon').className = 'feedback-icon success';
                    requirementItems[0].querySelector('.feedback-icon').innerHTML = '✓';
                } else {
                    requirementItems[0].querySelector('.feedback-icon').className = 'feedback-icon';
                    requirementItems[0].querySelector('.feedback-icon').innerHTML = '✗';
                }

                // 实现2位全加器功能
                const hasAdder = placedComponents.some(comp => comp.name === '加法器');
                const adderConnected = hasAdder && wires.some(wire => {
                    const adderComp = placedComponents.find(comp =>
                        (comp.id === wire.startComponentId || comp.id === wire.endComponentId) &&
                        comp.name === '加法器'
                    );
                    return adderComp;
                });

                if (hasAdder && hasLogicGates && adderConnected) {
                    requirementItems[1].querySelector('.feedback-icon').className = 'feedback-icon success';
                    requirementItems[1].querySelector('.feedback-icon').innerHTML = '✓';
                } else {
                    requirementItems[1].querySelector('.feedback-icon').className = 'feedback-icon';
                    requirementItems[1].querySelector('.feedback-icon').innerHTML = '✗';
                }

                // 添加输入开关和输出显示
                const hasSwitch = placedComponents.some(comp => comp.name === '开关' || comp.name === '按钮');
                const switchConnected = hasSwitch && wires.some(wire => {
                    const switchComp = placedComponents.find(comp =>
                        comp.id === wire.startComponentId &&
                        (comp.name === '开关' || comp.name === '按钮')
                    );
                    return switchComp;
                });

                if (hasInputOutput && hasOutput && hasSwitch && switchConnected && outputConnected) {
                    requirementItems[2].querySelector('.feedback-icon').className = 'feedback-icon success';
                    requirementItems[2].querySelector('.feedback-icon').innerHTML = '✓';
                } else {
                    requirementItems[2].querySelector('.feedback-icon').className = 'feedback-icon';
                    requirementItems[2].querySelector('.feedback-icon').innerHTML = '✗';
                }

                // 计算总分
                let score = 0;
                const allFeedbackItems = document.querySelectorAll('.feedback-item');
                allFeedbackItems.forEach(item => {
                    if (item.querySelector('.feedback-icon').classList.contains('success')) {
                        score += 15; // 每项满分15分
                    }
                });

                // 更新分数显示
                const scoreValue = document.querySelector('.score-value');
                scoreValue.textContent = `${score}/100`;

                // 更新进度条
                const progressFill = document.querySelector('.progress-fill');
                progressFill.style.width = `${score}%`;
            }

            // 更新反馈
            function updateFeedback() {
                evaluateCircuit();
            }
        });
    </script>
</body>

</html>